name: Deploy

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy (Proxy + Prod + Test)
    runs-on: ubuntu-latest
    environment: production
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Deploy auf Server (rsync + Docker)
        env:
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_USER: ${{ secrets.SSH_USER }}
          DEPLOY_PATH: ${{ secrets.DEPLOY_PATH || '~/kalender' }}
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          CERTBOT_EMAIL: ${{ secrets.CERTBOT_EMAIL || 'admin@jlssrv.de' }}
        run: |
          set -e
          mkdir -p ~/.ssh
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh -o StrictHostKeyChecking=no -i ~/.ssh/deploy_key ${SSH_USER}@${SSH_HOST} "mkdir -p ${DEPLOY_PATH}"

          rsync -avz --delete \
            --exclude '.git' \
            --exclude 'frontend/node_modules' \
            --exclude 'frontend/.next' \
            --exclude 'backend/__pycache__' \
            --exclude 'data' \
            --exclude '.env' \
            -e "ssh -o StrictHostKeyChecking=no -i $HOME/.ssh/deploy_key" \
            ./ ${SSH_USER}@${SSH_HOST}:${DEPLOY_PATH}/

          ssh -o StrictHostKeyChecking=no -i ~/.ssh/deploy_key ${SSH_USER}@${SSH_HOST} "cd ${DEPLOY_PATH} && \
            export CERTBOT_EMAIL=${CERTBOT_EMAIL} && \
            docker network create kalender-shared 2>/dev/null || true && \
            docker compose -p kalender-prod -f docker-compose.yml down 2>/dev/null || true && \
            docker compose -p kalender-prod -f docker-compose.yml up -d --build && \
            docker compose -p kalender-test -f docker-compose.test.yml down 2>/dev/null || true && \
            docker compose -p kalender-test -f docker-compose.test.yml up -d --build && \
            docker compose -p kalender-proxy -f docker-compose.proxy.yml down 2>/dev/null || true && \
            docker compose -p kalender-proxy -f docker-compose.proxy.yml up -d --build && \
            docker compose -p kalender-proxy -f docker-compose.proxy.yml exec -T nginx nginx -s reload 2>/dev/null || true"
