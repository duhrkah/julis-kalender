# Zertifikat-Erneuerung (täglich)
# Zertifikate für alle Domains (kalender + kalender-test + kalender-buvo)

name: Certbot Renew

on:
  schedule:
    - cron: '0 3 * * *'  # Täglich 3:00 UTC
  workflow_dispatch:

jobs:
  renew:
    name: Renew Zertifikate
    runs-on: ubuntu-latest
    steps:
      - name: Renew & Reload
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST_TEST || secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER_TEST || secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            cd ${{ secrets.DEPLOY_PATH_TEST || secrets.DEPLOY_PATH || '~/kalender' }}
            docker compose -p kalender-proxy -f docker-compose.proxy.yml --profile renew run --rm certbot renew --webroot -w /var/www/certbot --quiet 2>/dev/null || true
            docker compose -p kalender-proxy -f docker-compose.proxy.yml exec -T nginx nginx -s reload 2>/dev/null || true
